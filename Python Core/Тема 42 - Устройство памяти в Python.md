# Тема 42 - Устройство памяти в Python `[]`

`[Компьютерная память]` - область в компьютере, отведенная для хранения информации. Выделяют два основных типа памяти:

   - Внутренняя память
   - Внешняя память
#

### Внутренняя память

`[Внутренняя память]` - это форма компьютерной памяти, которая используется для хранения постоянной и временной информации о работе ПО. Внутренняя, потому что находится внутри компьютера. Внутренняя память подразделяется на:

 - Постоянную память
 - Оперативную память
 - Кэш-память

<details>
<summary>Структура внутренней памяти</summary> 

- `[Постоянная память]` - ROM (Read Only Memory) - это тип памяти компьютера, в которой информация может быть записана только один раз, а затем остается неизменной или только для чтения. ROM используется для хранения постоянной информации, такой как начальная загрузка компьютера (BIOS или UEFI), основные инструкции для запуска операционной системы и другие важные данные, которые не должны изменяться.

- Постоянная память — устройство для долговременного хранения программ и данных.
#
- `[Оперативная память]` - RAM (Random Access Memory) - это форма компьютерной памяти, которая используется для временного хранения данных и инструкций во время выполнения программ. Она обеспечивает быстрый доступ к данным, которые процессор может использовать непосредственно, и предоставляет рабочее пространство для операционной системы и приложений.

- Оперативная память волатильна - данные в ней хранятся только во время работы компьютера и теряются при его выключении.
- Оперативная память характеризуется высоким быстродействием и относительно малой емкостью.
#
- `[Кэш-память]` -  (Cache Memory) это небольшая, но очень быстрая форма компьютерной памяти, которая используется для временного хранения данных, наиболее часто используемых процессором. Её цель - ускорить доступ к данным, уменьшая время ожидания процессора при доступе к информации.

- Кэш-память работает как буфер между процессором и оперативной памятью, кэш-память содержит копии данных, которые процессор часто запрашивает, что позволяет уменьшить задержки при доступе к оперативной памяти.

`[Кэш-память имеет 3 уровня: L1, L2, L3]`

- Кэш первого уровня (L1) - располагается в самом процессоре, что делает его самым быстрым, но и наименее емким.
- Кэш второго уровня (L2) - второй уровень более масштабный, нежели первый, но в результате, обладает меньшими скоростными характеристиками.
- Кэш третьего уровня (L3) - третий уровень, более медленный, нежели два предыдущих. Но всё равно он гораздо быстрее, чем оперативная память. 

</details>

#

### Внешняя память

`[Внешняя память]` - (External Memory) это форма компьютерной памяти, которая используется для долгосрочного хранения данных и программ. Она предоставляет постоянное хранилище информации, которое сохраняется даже при выключении компьютера.

Основные виды внешней памяти:

- Жесткие магнитные диски (HDD - Hard Disk Drive)
- Твёрдотельные накопители (SSD - Solid State Drive)
- Флэш накопители
  
Основные характеристики внешней памяти:

- Постоянное хранение
- Большой объем хранения
- Более медленный доступ

#

### Управление памятью

- `[Управление памятью]` - это процесс выделения, распределения и координации памяти таким образом, чтобы все программы работали правильно и могли оптимально получать доступ к различным системным ресурсам.

Управление памятью также включает в себя и очистку памяти от объектов, которые больше не нужны.

Существует два типа управления памятью:

   - Ручное управление памятью
   - Автоматическое управление памятью
#

- `[Ручное управление памятью]` - включает в себя, как правило, три этапа:

- Запрос памяти у операционной системы
- Работа с ней
- Возвращение памяти обратно в операционную систему

Управлять памятью вручную — сложный процесс, поскольку легко забыть вернуть память обратно операционной системе, в результате чего возникает утечка: программа держит неиспользуемую память просто так, не давая применять ее для решения других задач.

#

- `[Ручное управление памятью]` - берет на себя самый сложный этап — возвращение памяти обратно операционной системе, когда она уже не требуется. Восстановленная память может использоваться другими объектами. 

#

### Механизм памяти в Python

- `[Python]` - язык автоматического управления памятью.

При запуске Python программы создается новый процесс, в рамках которого операционная система выделяет пул ресурсов, включая виртуальное адресное пространство. В эту память загружается интерпретатор Python вместе со всеми необходимыми ему для работы данными, включая код программы. 

Оставшаяся свободная виртуальная память используется для хранения Python объектов. Для управления этой памятью в Python используется специальный механизм, который называется аллокатор.

#

`[Аллокатор]` для малых объектов (не больше 512 байт) использует три уровня абстракции:

- Блок — кусок памяти, используемый для хранения одного объекта
- Пул — кусок памяти, содержащий блоки (обычно одна страница виртуальной памяти размером 4 килобайта)
- Арена — большой непрерывный кусок памяти, содержащий пулы (обычно содержит несколько страниц виртуальной памяти и имеет размер 256 килобайт)

<details>
<summary>Абстракция Аллокатора</summary> 

1. Блок — это кусок памяти, который может содержать только один Python объект фиксированного размера. Размер блока может варьироваться от 8 до 512 байт и должен быть кратен восьми. Все блоки в конкретном пуле имеют одинаковый размер и находятся в одном классе размера, который и определяет размер блока.

2. Пул - состоит из блоков одного размера.  Размер пула равен 4 килобайта.

Пулы находятся в трех состояниях:

- используемый (used) — частично заполненный, какие-то блоки заняты, какие-то свободны
- полный (full) — полностью заполненный, все блоки заняты 
- пустой (empty) — все блоки свободны и доступны для записи (хранятся в списке пустых пулов freepools)

Используемый пул содержит блоки, в которые можно записать какую-то информацию. Блоки полного пула все распределены и уже содержат данные. Пустые пулы не содержат данных и могут быть разбиты на какие угодны классы размера при необходимости

Обратите внимание, что пулы и блоки не выделяют память напрямую, вместо этого они используют уже выделенное пространство в аренах.

3. Арена – это кусок памяти размером в 256 килобайт, который обеспечивает память для 64 пулов.

Арены, в отличие от пулов, не имеют явных разделений на состояния. Они сами по себе организованы в двухсвязный список usable_arenas. Этот список отсортирован по количеству свободных пулов. Чем меньше свободных пулов, тем ближе арена к началу списка.







</details>
